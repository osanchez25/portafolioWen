<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Spa Canino Elly — Portafolio</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="styles/index.css">
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <img src="assets/wen.JPEG" alt="Foto del propietario" class="owner-pic" />
      <div>
        <h1>Spa Canino Elly <span style="font-weight:600;color:#d6e6ff">por Wendy Cordero</span></h1>
        <div class="sub">Transformaciones para peludos con alma de protagonista ✨</div>
      </div>
      <span class="tag">Grooming • Estilo • Mimos fotogénicos</span>
    </header>

    <section>
      <div class="section-title">Galería destacada</div>
      <div class="grid" id="cardsGrid"></div>
    </section>

    <footer style="margin-top:48px;padding:24px 0;text-align:center;color:#A8B3C7">
      © <span id="year"></span> By Oscar Sanchez
              <div style="margin-bottom:8px;font-size:0.95rem;color:#A8B3C7;opacity:0.8;">Versión 1.2.0</div>

    </footer>
  </div>

  <!-- Modal -->
  <div class="modal" id="petModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <strong class="modal-title" id="modalTitle">Detalle</strong>
        <button class="modal-close" id="modalClose" aria-label="Cerrar">✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Visor de imagen a tamaño completo -->
  <div class="img-modal" id="imgModal" role="dialog" aria-modal="true">
    <button class="img-modal-close" id="imgModalClose" aria-label="Cerrar imagen">✕</button>
    <button class="img-modal-prev" id="imgModalPrev" aria-label="Imagen anterior">‹</button>
    <img id="imgModalImg" alt="" />
    <button class="img-modal-next" id="imgModalNext" aria-label="Imagen siguiente">›</button>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const toolIcon = (t='')=>{
      const s=t.toLowerCase();
      if(s.includes('shampoo'))return'🫧';
      if(s.includes('acondicion'))return'🫧';
      if(s.includes('keratina'))return'🧴';
      if(s.includes('secadora')||s.includes('sopladora'))return'💨';
      if(s.includes('uñas'))return'🧰';
      if(s.includes('tijera'))return'✂️';
      if(s.includes('máquina')||s.includes('maquina'))return'🔌';
      if(s.includes('peine'))return'🪮';
      if(s.includes('cepillo'))return'🧹';
      if(s.includes('algodón'))return'💊';
      if(s.includes('oídos')||s.includes('oidos'))return'🧼';
      if(s.includes('talco hemost'))return'🧴';
      if(s.includes('pinza hemost'))return'🔧';
      if(s.includes('bálsamo')||s.includes('balsamo'))return'🧴';
      if(s.includes('perfume'))return'🌸';
      if(s.includes('bozal'))return'🦴';
      if(s.includes('papel aluminio'))return'🧻';
      if(s.includes('tinte'))return'🎨';
      if(s.includes('pañ')||s.includes('paño'))return'🧽';
      if(s.includes('lavanda')||s.includes('menta')||s.includes('eucalipto')||s.includes('alpiste')||s.includes('esencia'))return'🌿';
      if(s.includes('accesorio'))return'🎀';
      return'🧩';
    };
    const makeToolsBadges=(tools=[])=>tools.length
      ?'<div class="tool-badges">'+tools.map(t=>`<span class="tool"><span class="i">${toolIcon(t)}</span>${t}</span>`).join('')+'</div>'
      :'';

    const imageDecodeCache=new Map();
    function warmImage(img){
      if(!img) return Promise.resolve();
      const src=img.currentSrc||img.src;
      if(!src) return Promise.resolve();
      if(img.complete && img.naturalWidth>0) return Promise.resolve();
      if(imageDecodeCache.has(src)) return imageDecodeCache.get(src);
      const promise=(img.decode?img.decode():new Promise((resolve,reject)=>{
        if(img.complete && img.naturalWidth>0){ resolve(); return; }
        const onLoad=()=>{cleanup();resolve();};
        const onError=(err)=>{cleanup();imageDecodeCache.delete(src);reject(err);};
        const cleanup=()=>{
          img.removeEventListener('load',onLoad);
          img.removeEventListener('error',onError);
        };
        img.addEventListener('load',onLoad,{once:true});
        img.addEventListener('error',onError,{once:true});
      }));
      imageDecodeCache.set(src,promise.catch(()=>imageDecodeCache.delete(src)));
      return promise;
    }

    function preloadNeighbors(imgs,index){
      if(!imgs||!imgs.length) return;
      const len=imgs.length;
      const uniqueIndices=new Set();
      uniqueIndices.add(index);
      if(len>1) uniqueIndices.add((index+1)%len);
      if(len>2) uniqueIndices.add((index-1+len)%len);
      uniqueIndices.forEach(i=>{
        const target=imgs[i];
        if(!target) return;
        if(target.loading==='lazy') target.loading='eager';
        target.decoding='async';
        warmImage(target).catch(()=>{});
      });
    }

    function wireCarousel(root){
      root.querySelectorAll('[data-carousel]').forEach(c=>{
        const track=c.querySelector('.track'), prev=c.querySelector('.prev'), next=c.querySelector('.next');
        const imgNodes=track?track.querySelectorAll('img'):[];
        const imgs=[...imgNodes];
        if(!track||!prev||!next||imgs.length===0) return;
        let idx=0;
        imgs.forEach((img,i)=>{
          if(i===0) img.loading='eager';
          img.decoding='async';
        });
        const update=()=>{
          track.style.transform=`translateX(-${idx*100}%)`;
          preloadNeighbors(imgs,idx);
        };
        const goPrev=()=>{ idx=(idx-1+imgs.length)%imgs.length; update(); };
        const goNext=()=>{ idx=(idx+1)%imgs.length; update(); };
        prev.addEventListener('click',goPrev);
        next.addEventListener('click',goNext);
        imgs.forEach((img,i)=>{
          img.tabIndex=0;
          img.setAttribute('role','button');
          img.addEventListener('click',()=>openImgModal(imgs,i));
          img.addEventListener('keydown',e=>{ if(e.key==='Enter' || e.key===' ') openImgModal(imgs,i); });
        });
        update();
      });
    }

    const modal=document.getElementById('petModal');
    const modalBody=document.getElementById('modalBody');
    const modalTitle=document.getElementById('modalTitle');
    const closeBtn=document.getElementById('modalClose');

    const imgModal=document.getElementById('imgModal');
    const imgModalImg=document.getElementById('imgModalImg');
    const imgModalClose=document.getElementById('imgModalClose');
    const imgModalPrev=document.getElementById('imgModalPrev');
    const imgModalNext=document.getElementById('imgModalNext');
    let imgModalImgs=[];
    let imgModalIdx=0;
    let imgModalLoadToken=0;
    let imgModalLastIdx=0;
    function openModal(idx){
      const tmpl=document.getElementById('pet-detail-'+idx);
      if(!tmpl) return;
      modalBody.innerHTML=tmpl.innerHTML;
      modalTitle.textContent=tmpl.getAttribute('data-title')||'Detalle';
      modal.classList.add('open');
      document.body.classList.add('no-scroll'); // lock background
      wireCarousel(modalBody);
      closeBtn.focus();
    }
    function closeModal(){
      modal.classList.remove('open');
      modalBody.innerHTML='';
      document.body.classList.remove('no-scroll');
    }
    closeBtn.addEventListener('click',closeModal);
    modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });

    async function showImgModal(isFirstImage = false){
      const img=imgModalImgs[imgModalIdx];
      if(!img) return;
      const src=img.currentSrc||img.src;
      if(!src) return;
      const token=++imgModalLoadToken;
      // Determine direction
      let direction = '';
      if (imgModalIdx > imgModalLastIdx) direction = 'slide-right';
      else if (imgModalIdx < imgModalLastIdx) direction = 'slide-left';
      imgModalLastIdx = imgModalIdx;

      // Slide out old image (skip if this is the first image of a newly opened modal)
      if(imgModalImg.src && !isFirstImage && direction) {
        imgModalImg.classList.remove('slide-in');
        imgModalImg.classList.add(direction);
        await new Promise(res => {
          imgModalImg.addEventListener('transitionend', res, {once:true});
          // Force reflow for transition
          imgModalImg.offsetWidth;
        });
        imgModalImg.classList.remove('slide-left','slide-right');
      }

      try{ await warmImage(img); }catch(e){ console.warn('No se pudo precargar la imagen',e); }
      if(token!==imgModalLoadToken) return;
      // Reset onload handler to avoid stacking
      imgModalImg.onload = null;
      imgModalImg.src = src;
      imgModalImg.alt = img.alt || '';
      // Slide in new image
      imgModalImg.classList.add('slide-in');
      imgModalImg.onload = () => {
        imgModalImg.classList.remove('loading');
        imgModalImg.classList.add('slide-in');
        imgModalImg.style.opacity = 1;
      };
      // If already loaded (from cache), trigger slide in immediately
      if (imgModalImg.complete && imgModalImg.naturalWidth > 0) {
        imgModalImg.classList.remove('loading');
        imgModalImg.classList.add('slide-in');
        imgModalImg.style.opacity = 1;
      }
      const many=imgModalImgs.length>1;
      imgModalPrev.style.display=many?'block':'none';
      imgModalNext.style.display=many?'block':'none';
      preloadNeighbors(imgModalImgs,imgModalIdx);
    }
    function openImgModal(imgs,idx){
  // Reset modal image state before opening new modal
  imgModalImg.onload = null;
  imgModalImg.src = ''; // Clear old image to prevent conflicts
  imgModalImg.alt = '';
  imgModalImg.classList.remove('loading','slide-left','slide-right','slide-in');
  imgModalImg.style.opacity = 1;
  imgModalImgs=[...imgs];
  imgModalIdx=idx;
  imgModalLastIdx=idx; // Reset last index so no slide on first open
  showImgModal(true); // Pass true to indicate this is the first image of a new modal
  imgModal.classList.add('open');
  document.body.classList.add('no-scroll');
  imgModalClose.focus();
    }
    function closeImgModal(){
  imgModal.classList.remove('open');
  // Fully reset modal image state
  imgModalImg.onload = null;
  imgModalImg.src = '';
  imgModalImg.alt = '';
  imgModalImg.classList.remove('loading','slide-left','slide-right','slide-in');
  imgModalImg.style.opacity = 1;
  imgModalImgs = [];
  imgModalLoadToken++;
  if(!modal.classList.contains('open')) document.body.classList.remove('no-scroll');
    }
    function showPrev(){
      if(imgModalImgs.length<2) return;
      imgModalIdx=(imgModalIdx-1+imgModalImgs.length)%imgModalImgs.length;
      showImgModal();
    }
    function showNext(){
      if(imgModalImgs.length<2) return;
      imgModalIdx=(imgModalIdx+1)%imgModalImgs.length;
      showImgModal();
    }
    imgModalPrev.addEventListener('click',showPrev);
    imgModalNext.addEventListener('click',showNext);
    imgModalClose.addEventListener('click',closeImgModal);
    imgModal.addEventListener('click',e=>{ if(e.target===imgModal||e.target===imgModalImg) closeImgModal(); });

    window.addEventListener('keydown',e=>{
      if(imgModal.classList.contains('open')){
        if(e.key==='Escape') closeImgModal();
        else if(e.key==='ArrowLeft') showPrev();
        else if(e.key==='ArrowRight') showNext();
      }else if(modal.classList.contains('open') && e.key==='Escape'){
        closeModal();
      }
    });

    fetch('pets.json')
      .then(r=>r.json())
      .then(pets=>renderPets(pets))
      .catch(err=>console.error('Error cargando pets.json',err));

    function renderPets(pets){
      pets.sort((a,b)=>(a.id ?? 0)-(b.id ?? 0));
      const grid=document.getElementById('cardsGrid');
      grid.innerHTML='';
      pets.forEach((p,i)=>{
        const index=p.id || (i+1);
        const card=document.createElement('article');
        card.className='card';
        card.dataset.index=index;
          const images=(p.extras||[]).filter(Boolean);
          // Create card
          card.innerHTML = `
            <div class="card-header">
              <h3 class="card-title">${p.title || 'Sin título'}</h3>
              <div class="card-proc">${p.name || 'Sin nombre'}</div>
            </div>
            <div class="thumb" aria-label="Vista previa de ${p.name}">
              <img alt="${p.name}" loading="lazy">
            </div>
            <a href="#" class="open-detail" data-open-detail data-index="${index}" aria-label="Ver detalle de ${p.name}" tabindex="0"></a>
          `;
          grid.appendChild(card);
          // Set image with fallback
          const thumbImg = card.querySelector('.thumb img');
          if (images[0]) setImageWithFallback(thumbImg, images[0]);

          // Modal template
          const tmpl=document.createElement('template');
          tmpl.id='pet-detail-'+index;
          tmpl.setAttribute('data-title', p.name||'Detalle');
          // Create carousel images with fallback
          const imgHtml=images.map(ph=>`<img alt="Foto de ${p.name}" loading="lazy">`).join('');
          tmpl.innerHTML=`
            <div class="detail-grid">
              <div>
                <div class="carousel" data-carousel>
                  <button class="prev" aria-label="Foto anterior">‹</button>
                  <div class="track">${imgHtml}</div>
                  <button class="next" aria-label="Foto siguiente">›</button>
                </div>
              </div>
              <div>
                <div class="section-sub">Procedimiento</div>
                <div class="text-block">${p.title || '—'}</div>

                <div class="section-sub">Descripción</div>
                <div class="text-block">${p.description||'—'}</div>

                <div class="section-sub">Herramientas</div>
                ${makeToolsBadges(p.tools)}
              </div>
            </div>
          `;
          document.body.appendChild(tmpl);
          // Set fallback for modal images
          const modalImgs = tmpl.content.querySelectorAll('.carousel img');
          images.forEach((ph, idx) => {
            if (modalImgs[idx]) setImageWithFallback(modalImgs[idx], ph);
          });

          /* Ajuste por-perro desde JSON (focusY: 0–100) */
          const focusY = (p.focusY ?? 42);
          card.querySelectorAll('.thumb img').forEach(img=>{
            img.style.objectPosition = `center ${focusY}%`;
          });
          tmpl.content.querySelectorAll('.carousel img').forEach(img=>{
            img.style.objectPosition = `center ${focusY}%`;
          });
      });

      /* Delegated click: hace clic en cualquier parte de la card */
      document.addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        if (!card) return;
        const idx = card.dataset.index || card.querySelector('[data-open-detail]')?.dataset.index;
        if (idx) { e.preventDefault(); openModal(idx); }
      });

      /* Hardcoded dedication card for Yuli */
      const dedicationCard = document.createElement('article');
      dedicationCard.className = 'card dedication-card';
      dedicationCard.innerHTML = `
        <div class="card-header">
          <h3 class="card-title">Dedicación Especial</h3>
          <div class="card-proc">Agradecimiento</div>
        </div>
        <div class="thumb" aria-label="Foto de Yuli">
          <img src="assets/yuli.jpg" alt="Yuli" loading="lazy" style="object-position: center 50%;">
        </div>
        <div class="dedication-text">
          A Yuli por su dedicación y trabajo en equipo, cualidades que hicieron posible este proyecto.
        </div>
      `;
      grid.appendChild(dedicationCard);
    }

    function setImageWithFallback(imgElement, path) {
      imgElement.src = path;
      imgElement.onerror = function() {
        // Try swapping extension case if not already tried
        if (path.match(/\\.jpg$/i)) {
          const altPath = path.replace(/\\.jpg$/i, '.JPG');
          if (imgElement.src !== altPath) {
            imgElement.src = altPath;
          }
        } else if (path.match(/\\.jpeg$/i)) {
          const altPath = path.replace(/\\.jpeg$/i, '.JPEG');
          if (imgElement.src !== altPath) {
            imgElement.src = altPath;
          }
        } else if (path.match(/\\.png$/i)) {
          const altPath = path.replace(/\\.png$/i, '.PNG');
          if (imgElement.src !== altPath) {
            imgElement.src = altPath;
          }
        }
      };
    }

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(err=>console.error('SW registration failed',err));
    }
  </script>
</body>
</html>
